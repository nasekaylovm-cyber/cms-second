name: DAST Testing with ZAP

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 2 * * *' # Запуск каждый день в 2:00

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up Java (required for ZAP)
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y owasp-zap
        
    - name: Start ZAP in daemon mode
      run: |
        zap-cli daemon start --port 8090
        sleep 30 # Ждем запуска ZAP
        
    - name: Check ZAP status
      run: |
        curl http://localhost:8090/JSON/core/core/status/?apikey=123456
        
    - name: Configure ZAP scan
      run: |
        # Настройка целевого URL
        curl -v "http://localhost:8090/JSON/ascan/action/scan?url=http://5.129.250.92&recursive=true&apikey=123456"
        
        # Ждем завершения сканирования
        while "$(curl -s "http://localhost:8090/JSON/ascan/view/scans/?apikey=123456" | grep -c 'inprogress')" -gt 0 ; do
          sleep 60
        done
        
    - name: Export scan results
      run: |
        # Создаем директорию для отчетов
        mkdir reports
        curl -o reports/DAST_Report.html "http://localhost:8090/OTHER/core/other/exportReport/?apikey=123456&name=DAST_Report&reportFormat=HTML"
        
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: dast-reports
        path: reports/

