name: CMS Deployment Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: 5.129.250.92
        username: root
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-dev postgresql postgresql-contrib libpq-dev patch
          
          # Скачиваем архив
          wget https://github.com/cms-dev/cms/releases/download/v1.2.0/v1.2.0.tar.gz
          tar -xf v1.2.0.tar.gz
          cd cms
          
          # Применяем исправление для Python 3
          sed -i 's/os.umask(0022)/os.umask(0o22)/g' setup.py
          
          # Установка CMS
          sudo python3 setup.py install
          
          # Настройка PostgreSQL
          sudo -u postgres psql -c "CREATE USER your_username WITH PASSWORD 'your_password';"
          createdb -O your_username your_database
          psql your_database -c 'ALTER SCHEMA public OWNER TO your_username'
          psql your_database -c 'GRANT SELECT ON pg_largeobject TO your_username'
          
          # Инициализация и запуск сервисов
          cmsInitDB
          cmsAdminWebServer 0
          cmsLogService 0
          cmsRankingWebServer
