name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy CMS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 5.129.250.92
        username: root
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          rm -rf /var/www/cms
          mkdir -p /var/www/cms
          cd /var/www/cms
          
          git clone https://github.com/cms-dev/cms.git .
          
          # Смотрим структуру проекта
          ls -la
          find . -name "setup.py" -o -name "pyproject.toml" | head -5
          
          # Пробуем установить
          python3 -m venv venv
          ./venv/bin/pip install -e . || ./venv/bin/pip install . || echo "Trying alternative installation"
          
          # Проверяем что есть в проекте
          ./venv/bin/python -c "
          import os
          print('Files in cms directory:')
          if os.path.exists('cms'):
              print(os.listdir('cms'))
          else:
              print('No cms directory found')
          "
